@model QueueViewModel
@{
    ViewData["Title"] = "Очередь этапов";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>Очередь этапов</h2>
            <p class="lead">Управление очередью выполнения и приоритизацией этапов</p>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-outline-primary" id="refresh-button">
                <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success mb-3">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mb-3">
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="queueTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-queue-tab" data-bs-toggle="tab" data-bs-target="#all-queue" type="button" role="tab" aria-controls="all-queue" aria-selected="true">
                                Все этапы
                            </button>
                        </li>
                        @foreach (var machine in Model.AvailableMachines)
                        {
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="machine-@machine.Id-tab" data-bs-toggle="tab" data-bs-target="#machine-@machine.Id" type="button" role="tab" aria-controls="machine-@machine.Id" aria-selected="false">
                                    @machine.Name
                                </button>
                            </li>
                        }
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="queueTabsContent">
                        <div class="tab-pane fade show active" id="all-queue" role="tabpanel" aria-labelledby="all-queue-tab">
                            @if (Model.QueueItems.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover" id="all-queue-table">
                                        <thead>
                                            <tr>
                                                <th>Деталь</th>
                                                <th>Этап</th>
                                                <th>Станок</th>
                                                <th>Ожидаемое начало</th>
                                                <th>Статус</th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.QueueItems.OrderBy(i => i.ExpectedStartTime))
                                            {
                                                <tr>
                                                    <td>@item.DetailName</td>
                                                    <td>@item.StageName</td>
                                                    <td>@item.ExpectedMachineName</td>
                                                    <td>@item.ExpectedStartTime.ToString("dd.MM.yyyy HH:mm")</td>
                                                    <td>
                                                        <span class="badge bg-warning text-dark">@GetStatusName(item.Status)</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-sm btn-outline-primary prioritize-btn"
                                                                    data-stage-id="@item.StageExecutionId"
                                                                    data-machine-id="@item.ExpectedMachineId"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#prioritizeModal">
                                                                <i class="bi bi-arrow-up-circle"></i> Приоритет
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary reassign-btn"
                                                                    data-stage-id="@item.StageExecutionId"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#reassignModal">
                                                                <i class="bi bi-arrow-left-right"></i> Переназначить
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-danger cancel-btn"
                                                                    data-stage-id="@item.StageExecutionId"
                                                                    data-stage-name="@item.StageName"
                                                                    data-detail-name="@item.DetailName"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#cancelModal">
                                                                <i class="bi bi-x-circle"></i> Отменить
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center p-5">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    <h4 class="mt-3">Очередь пуста</h4>
                                    <p class="text-muted">В настоящее время нет этапов, ожидающих выполнения.</p>
                                </div>
                            }
                        </div>

                        @foreach (var machine in Model.AvailableMachines)
                        {
                            <div class="tab-pane fade" id="machine-@machine.Id" role="tabpanel" aria-labelledby="machine-@machine.Id-tab">
                                @{
                                    var machineQueueItems = Model.QueueItems.Where(i => i.ExpectedMachineId == machine.Id).ToList();
                                }

                                @if (machineQueueItems.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Деталь</th>
                                                    <th>Этап</th>
                                                    <th>Ожидаемое начало</th>
                                                    <th>Статус</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in machineQueueItems.OrderBy(i => i.ExpectedStartTime))
                                                {
                                                    <tr>
                                                        <td>@item.DetailName</td>
                                                        <td>@item.StageName</td>
                                                        <td>@item.ExpectedStartTime.ToString("dd.MM.yyyy HH:mm")</td>
                                                        <td>
                                                            <span class="badge bg-warning text-dark">@GetStatusName(item.Status)</span>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group" role="group">
                                                                <button type="button" class="btn btn-sm btn-outline-primary prioritize-btn"
                                                                        data-stage-id="@item.StageExecutionId"
                                                                        data-machine-id="@item.ExpectedMachineId"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#prioritizeModal">
                                                                    <i class="bi bi-arrow-up-circle"></i> Приоритет
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary reassign-btn"
                                                                        data-stage-id="@item.StageExecutionId"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#reassignModal">
                                                                    <i class="bi bi-arrow-left-right"></i> Переназначить
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger cancel-btn"
                                                                        data-stage-id="@item.StageExecutionId"
                                                                        data-stage-name="@item.StageName"
                                                                        data-detail-name="@item.DetailName"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#cancelModal">
                                                                    <i class="bi bi-x-circle"></i> Отменить
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center p-5">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                        <h4 class="mt-3">Очередь на станок @machine.Name пуста</h4>
                                        <p class="text-muted">Нет этапов, ожидающих выполнения на этом станке.</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно приоритизации -->
<div class="modal fade" id="prioritizeModal" tabindex="-1" aria-labelledby="prioritizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prioritizeModalLabel">Приоритизация этапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="@Url.Action("Prioritize", "Queue")">
                <div class="modal-body">
                    <input type="hidden" name="stageId" id="prioritize-stage-id">
                    <input type="hidden" name="machineId" id="prioritize-machine-id">
                    <p>Вы собираетесь приоритизировать этап, что поставит его в начало очереди на станок.</p>
                    <p>Это может привести к приостановке текущего этапа, если выбран соответствующий режим.</p>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="true" id="priority-pause-current" name="pauseCurrent">
                        <label class="form-check-label" for="priority-pause-current">
                            Приостановить текущий этап для немедленного выполнения этого этапа
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="true" id="priority-notify" name="notify">
                        <label class="form-check-label" for="priority-notify">
                            Уведомить оператора станка
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Приоритизировать</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно переназначения -->
<div class="modal fade" id="reassignModal" tabindex="-1" aria-labelledby="reassignModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reassignModalLabel">Переназначение этапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="@Url.Action("Reassign", "Queue")">
                <div class="modal-body">
                    <input type="hidden" name="stageId" id="reassign-stage-id">
                    <p>Выберите станок, на который нужно переназначить этап:</p>
                    <div class="mb-3">
                        <label for="reassign-machine-select" class="form-label">Станок</label>
                        <select class="form-select" id="reassign-machine-select" name="machineId" required>
                            <option value="">Выберите станок...</option>
                            @foreach (var machine in Model.AvailableMachines)
                            {
                                <option value="@machine.Id">@machine.Name (@machine.MachineTypeName)</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Переназначить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно отмены -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">Отмена этапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="@Url.Action("Cancel", "Queue")">
                <div class="modal-body">
                    <input type="hidden" name="stageId" id="cancel-stage-id">
                    <p>Вы уверены, что хотите отменить этап <strong id="cancel-stage-name"></strong> для детали <strong id="cancel-detail-name"></strong>?</p>
                    <p class="text-danger">Это действие нельзя отменить. Отмена этапа может нарушить последовательность маршрута.</p>
                    <div class="mb-3">
                        <label for="cancel-reason" class="form-label">Причина отмены</label>
                        <textarea class="form-control" id="cancel-reason" name="reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Отменить этап</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Инициализация таблицы
            $('#all-queue-table').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Russian.json"
                },
                "pageLength": 25,
                "order": [[ 3, "asc" ]] // Сортировка по ожидаемому времени начала
            });

            // Обработчики кнопок
            $('.prioritize-btn').click(function() {
                var stageId = $(this).data('stage-id');
                var machineId = $(this).data('machine-id');

                $('#prioritize-stage-id').val(stageId);
                $('#prioritize-machine-id').val(machineId);
            });

            $('.reassign-btn').click(function() {
                var stageId = $(this).data('stage-id');

                $('#reassign-stage-id').val(stageId);
                $('#reassign-machine-select').val(''); // Сбрасываем выбор
            });

            $('.cancel-btn').click(function() {
                var stageId = $(this).data('stage-id');
                var stageName = $(this).data('stage-name');
                var detailName = $(this).data('detail-name');

                $('#cancel-stage-id').val(stageId);
                $('#cancel-stage-name').text(stageName);
                $('#cancel-detail-name').text(detailName);
            });

            // Кнопка обновления
            $('#refresh-button').click(function() {
                location.reload();
            });

            // Автоматическое обновление каждые 30 секунд
            setTimeout(function() {
                location.reload();
            }, 30000);
        });
    </script>
}

@functions {
    string GetStatusName(string status)
    {
        return status switch
        {
            "Waiting" => "В очереди",
            "Pending" => "Ожидает запуска",
            "InProgress" => "В работе",
            "Paused" => "На паузе",
            "Completed" => "Завершено",
            _ => status
        };
    }
}