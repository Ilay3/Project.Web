@model CreatePlanViewModel
@{
    ViewData["Title"] = "Создание производственного плана";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>Создание производственного плана</h2>
            <p class="lead">Укажите, какие детали и в каком количестве необходимо изготовить</p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("Summary", "Planning")" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> К сводке
            </a>
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mb-3">
            @TempData["ErrorMessage"]
        </div>
    }

    <form method="post" id="planning-form">
        <div class="row">
            <!-- Основные параметры плана -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Параметры плана</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="PlanName" class="form-label"></label>
                                <input asp-for="PlanName" class="form-control" placeholder="Введите название плана" required />
                                <span asp-validation-for="PlanName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="TargetDate" class="form-label"></label>
                                <input asp-for="TargetDate" type="date" class="form-control" required />
                                <span asp-validation-for="TargetDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Таблица деталей в плане -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Детали в плане</h5>
                        <button type="button" class="btn btn-primary btn-sm" id="add-item-btn">
                            <i class="bi bi-plus"></i> Добавить деталь
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="plan-items-table">
                                <thead>
                                    <tr>
                                        <th>Деталь</th>
                                        <th>Количество</th>
                                        <th>Оптимальный размер партии</th>
                                        <th>Деление на подпартии</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="plan-items-body">
                                    @if (Model.Items.Any())
                                    {
                                        @for (int i = 0; i < Model.Items.Count; i++)
                                        {
                                            <tr class="plan-item-row">
                                                <td>
                                                    <input type="hidden" name="Items[@i].DetailId" value="@Model.Items[i].DetailId" />
                                                    <input type="hidden" name="Items[@i].DetailName" value="@Model.Items[i].DetailName" />
                                                    <input type="hidden" name="Items[@i].DetailNumber" value="@Model.Items[i].DetailNumber" />
                                                    @Model.Items[i].DetailName (@Model.Items[i].DetailNumber)
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control quantity-input" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" min="1" required />
                                                </td>
                                                <td>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control optimal-batch-size" name="Items[@i].OptimalBatchSize" value="@Model.Items[i].OptimalBatchSize" min="0" />
                                                        <button type="button" class="btn btn-outline-primary calculate-optimal-btn"
                                                                data-detail-id="@Model.Items[i].DetailId"
                                                                data-detail-name="@Model.Items[i].DetailName">
                                                            <i class="bi bi-calculator"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-outline-secondary split-batch-btn"
                                                            data-detail-id="@Model.Items[i].DetailId"
                                                            data-detail-name="@Model.Items[i].DetailName"
                                                            data-index="@i">
                                                        <i class="bi bi-diagram-3"></i> Разделить
                                                    </button>
                                                    <div class="sub-batches-container mt-2">
                                                        @if (Model.Items[i].SubBatchSizes?.Any() == true)
                                                        {
                                                            <div class="small">
                                                                Подпартии:
                                                                @for (int j = 0; j < Model.Items[i].SubBatchSizes.Count; j++)
                                                                {
                                                                    <input type="hidden" name="Items[@i].SubBatchSizes[@j]" value="@Model.Items[i].SubBatchSizes[j]" />
                                                                    <span class="badge bg-secondary me-1">@Model.Items[i].SubBatchSizes[j]</span>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-danger remove-item-btn">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div id="empty-plan-message" class="text-center p-4 @(Model.Items.Any() ? "d-none" : "")">
                            <i class="bi bi-inbox-fill" style="font-size: 3rem;"></i>
                            <p class="mt-3">Добавьте детали в план производства</p>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary" id="submit-plan-btn">
                            <i class="bi bi-check-lg"></i> Создать план
                        </button>
                    </div>
                </div>
            </div>

            <!-- Дополнительная информация -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Доступные детали</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="detail-search" placeholder="Поиск детали...">
                        </div>
                        <div class="list-group" id="details-list">
                            @foreach (var detail in Model.AvailableDetails)
                            {
                                <button type="button" class="list-group-item list-group-item-action detail-item"
                                        data-detail-id="@detail.Id"
                                        data-detail-name="@detail.Name"
                                        data-detail-number="@detail.Number">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@detail.Name</strong>
                                            <div class="small text-muted">№ @detail.Number</div>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">
                                            <i class="bi bi-plus"></i>
                                        </span>
                                    </div>
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <div class="card" id="optimal-batch-card" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Оптимальный размер партии</h5>
                        <button type="button" class="btn-close" id="close-optimal-batch-card"></button>
                    </div>
                    <div class="card-body">
                        <h6 id="optimal-batch-detail" class="mb-3"></h6>
                        <p>Оптимальный размер партии: <strong id="optimal-batch-size"></strong></p>
                        <div id="batch-size-options"></div>

                        <div class="d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-primary" id="apply-optimal-batch-btn">
                                Применить оптимальный размер
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Модальное окно для разделения на подпартии -->
<div class="modal fade" id="splitBatchModal" tabindex="-1" aria-labelledby="splitBatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="splitBatchModalLabel">Деление на подпартии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="split-detail-index">
                <p>Деталь: <strong id="split-detail-name"></strong></p>
                <p>Количество: <strong id="split-detail-quantity"></strong></p>

                <div class="mb-3">
                    <label for="split-strategy" class="form-label">Способ деления</label>
                    <select class="form-select" id="split-strategy">
                        <option value="equal">Равные подпартии</option>
                        <option value="custom">Произвольный размер</option>
                        <option value="optimal">По оптимальному размеру</option>
                    </select>
                </div>

                <div id="equal-split-container">
                    <div class="mb-3">
                        <label for="sub-batch-count" class="form-label">Количество подпартий</label>
                        <input type="number" class="form-control" id="sub-batch-count" min="2" value="2">
                    </div>
                </div>

                <div id="custom-split-container" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Размеры подпартий</label>
                        <div id="custom-sub-batches">
                            <div class="input-group mb-2">
                                <span class="input-group-text">Подпартия 1</span>
                                <input type="number" class="form-control custom-sub-batch" min="1">
                                <button type="button" class="btn btn-outline-danger remove-sub-batch-btn">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Подпартия 2</span>
                                <input type="number" class="form-control custom-sub-batch" min="1">
                                <button type="button" class="btn btn-outline-danger remove-sub-batch-btn">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-sub-batch-btn">
                            <i class="bi bi-plus"></i> Добавить подпартию
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">Общее количество:</span>
                            <span id="custom-total">0</span> / <span id="custom-target">0</span>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="balance-sub-batches-btn">
                            Выровнять
                        </button>
                    </div>
                </div>

                <div id="optimal-split-container" style="display: none;">
                    <div class="mb-3">
                        <label for="optimal-size" class="form-label">Оптимальный размер подпартии</label>
                        <input type="number" class="form-control" id="optimal-size" min="1">
                    </div>
                    <div id="optimal-sub-batches-preview" class="mb-3"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="apply-split-btn">Применить</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Поиск деталей
            $('#detail-search').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#details-list .detail-item').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Добавление детали в план
            $('.detail-item').click(function() {
                var detailId = $(this).data('detail-id');
                var detailName = $(this).data('detail-name');
                var detailNumber = $(this).data('detail-number');

                // Проверяем, не добавлена ли уже эта деталь
                var existingRow = $('.plan-item-row').filter(function() {
                    return $(this).find('input[name$=".DetailId"]').val() == detailId;
                });

                if (existingRow.length > 0) {
                    // Увеличиваем количество
                    var quantityInput = existingRow.find('.quantity-input');
                    quantityInput.val(parseInt(quantityInput.val()) + 1);

                    // Выделяем строку
                    existingRow.addClass('table-primary');
                    setTimeout(function() {
                        existingRow.removeClass('table-primary');
                    }, 1000);

                    return;
                }

                // Добавляем новую строку
                var index = $('.plan-item-row').length;
                var newRow = `
                    <tr class="plan-item-row table-success">
                        <td>
                            <input type="hidden" name="Items[${index}].DetailId" value="${detailId}" />
                            <input type="hidden" name="Items[${index}].DetailName" value="${detailName}" />
                            <input type="hidden" name="Items[${index}].DetailNumber" value="${detailNumber}" />
                            ${detailName} (${detailNumber})
                        </td>
                        <td>
                            <input type="number" class="form-control quantity-input" name="Items[${index}].Quantity" value="1" min="1" required />
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="number" class="form-control optimal-batch-size" name="Items[${index}].OptimalBatchSize" value="0" min="0" />
                                <button type="button" class="btn btn-outline-primary calculate-optimal-btn"
                                        data-detail-id="${detailId}"
                                        data-detail-name="${detailName}">
                                    <i class="bi bi-calculator"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            <button type="button" class="btn btn-outline-secondary split-batch-btn"
                                    data-detail-id="${detailId}"
                                    data-detail-name="${detailName}"
                                    data-index="${index}">
                                <i class="bi bi-diagram-3"></i> Разделить
                            </button>
                            <div class="sub-batches-container mt-2"></div>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-item-btn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                $('#plan-items-body').append(newRow);

                // Скрываем сообщение о пустом плане
                $('#empty-plan-message').addClass('d-none');

                // Плавно убираем выделение строки
                setTimeout(function() {
                    $('.plan-item-row').removeClass('table-success');
                }, 1000);
            });

            // Удаление детали из плана
            $(document).on('click', '.remove-item-btn', function() {
                $(this).closest('tr').remove();

                // Если план пуст, показываем сообщение
                if ($('.plan-item-row').length === 0) {
                    $('#empty-plan-message').removeClass('d-none');
                }

                // Обновляем индексы
                updateIndexes();
            });

            // Обновление индексов при изменении количества элементов
            function updateIndexes() {
                $('.plan-item-row').each(function(index) {
                    $(this).find('input[name^="Items["]').each(function() {
                        var name = $(this).attr('name');
                        var newName = name.replace(/Items\[\d+\]/, `Items[${index}]`);
                        $(this).attr('name', newName);
                    });

                    $(this).find('.split-batch-btn').attr('data-index', index);
                });
            }

            // Расчет оптимального размера партии
            $(document).on('click', '.calculate-optimal-btn', function() {
                var detailId = $(this).data('detail-id');
                var detailName = $(this).data('detail-name');
                var row = $(this).closest('tr');

                // Показываем карточку с расчетом
                $('#optimal-batch-card').show();
                $('#optimal-batch-detail').text(detailName);

                // Запрашиваем оптимальный размер партии
                $.getJSON(`/Planning/OptimalBatchSize?detailId=${detailId}`, function(data) {
                    $('#optimal-batch-size').text(data.optimalBatchSize);

                    // Отображаем варианты размеров партий
                    var optionsHtml = '<div class="table-responsive mt-3"><table class="table table-sm"><thead><tr>' +
                                     '<th>Размер</th><th>Общее время</th><th>Время переналадки</th><th>Среднее на единицу</th>' +
                                     '</tr></thead><tbody>';

                    data.batchSizeOptions.forEach(function(option) {
                        optionsHtml += `<tr class="${option.batchSize === data.optimalBatchSize ? 'table-success' : ''}">
                            <td>${option.batchSize}</td>
                            <td>${option.totalTimeForBatch} ч</td>
                            <td>${option.setupTime} ч</td>
                            <td>${option.avgTimePerUnit} ч</td>
                        </tr>`;
                    });

                    optionsHtml += '</tbody></table></div>';
                    $('#batch-size-options').html(optionsHtml);

                    // Запоминаем строку и оптимальный размер для кнопки "Применить"
                    $('#apply-optimal-batch-btn').data('row', row);
                    $('#apply-optimal-batch-btn').data('size', data.optimalBatchSize);
                }).fail(function() {
                    $('#optimal-batch-size').text('Ошибка расчета');
                    $('#batch-size-options').html('<div class="alert alert-danger">Не удалось рассчитать оптимальный размер партии</div>');
                });
            });

            // Закрытие карточки с оптимальным размером
            $('#close-optimal-batch-card').click(function() {
                $('#optimal-batch-card').hide();
            });

            // Применение оптимального размера партии
            $('#apply-optimal-batch-btn').click(function() {
                var row = $(this).data('row');
                var size = $(this).data('size');

                if (row && size) {
                    row.find('.optimal-batch-size').val(size);
                    $('#optimal-batch-card').hide();
                }
            });

            // Открытие модального окна для разделения на подпартии
            $(document).on('click', '.split-batch-btn', function() {
                var detailId = $(this).data('detail-id');
                var detailName = $(this).data('detail-name');
                var index = $(this).data('index');
                var row = $(this).closest('tr');
                var quantity = parseInt(row.find('.quantity-input').val());
                var optimalSize = parseInt(row.find('.optimal-batch-size').val()) || 0;

                $('#split-detail-name').text(detailName);
                $('#split-detail-quantity').text(quantity);
                $('#split-detail-index').val(index);

                // Сбрасываем форму
                $('#split-strategy').val('equal');
                $('#sub-batch-count').val(2);
                $('#optimal-size').val(optimalSize > 0 ? optimalSize : Math.max(10, Math.floor(quantity / 3)));

                // Показываем контейнер для равных подпартий
                $('#equal-split-container').show();
                $('#custom-split-container').hide();
                $('#optimal-split-container').hide();

                // Генерируем предпросмотр для равных подпартий
                generateEqualSplitPreview();

                // Обновляем данные для произвольного деления
                $('#custom-target').text(quantity);
                $('.custom-sub-batch').val(Math.floor(quantity / 2));
                updateCustomTotal();

                $('#splitBatchModal').modal('show');
            });

            // Изменение стратегии деления
            $('#split-strategy').change(function() {
                var strategy = $(this).val();

                if (strategy === 'equal') {
                    $('#equal-split-container').show();
                    $('#custom-split-container').hide();
                    $('#optimal-split-container').hide();

                    generateEqualSplitPreview();
                } else if (strategy === 'custom') {
                    $('#equal-split-container').hide();
                    $('#custom-split-container').show();
                    $('#optimal-split-container').hide();

                    updateCustomTotal();
                } else if (strategy === 'optimal') {
                    $('#equal-split-container').hide();
                    $('#custom-split-container').hide();
                    $('#optimal-split-container').show();

                    generateOptimalSplitPreview();
                }
            });

            // Изменение количества равных подпартий
            $('#sub-batch-count').change(function() {
                generateEqualSplitPreview();
            });

            // Изменение оптимального размера
            $('#optimal-size').change(function() {
                generateOptimalSplitPreview();
            });

            // Генерация предпросмотра для равных подпартий
            function generateEqualSplitPreview() {
                var quantity = parseInt($('#split-detail-quantity').text());
                var count = parseInt($('#sub-batch-count').val());

                if (isNaN(quantity) || isNaN(count) || count < 1) return;

                var baseSize = Math.floor(quantity / count);
                var remainder = quantity % count;

                var sizes = [];
                for (var i = 0; i < count; i++) {
                    sizes.push(i < remainder ? baseSize + 1 : baseSize);
                }

                showOptimalPreview(sizes);
            }

            // Генерация предпросмотра для оптимального размера
            function generateOptimalSplitPreview() {
                var quantity = parseInt($('#split-detail-quantity').text());
                var optimalSize = parseInt($('#optimal-size').val());

                if (isNaN(quantity) || isNaN(optimalSize) || optimalSize < 1) return;

                var sizes = [];
                var remaining = quantity;

                while (remaining > 0) {
                    var size = Math.min(remaining, optimalSize);
                    sizes.push(size);
                    remaining -= size;
                }

                showOptimalPreview(sizes);
            }

            // Отображение предпросмотра для оптимальных подпартий
            function showOptimalPreview(sizes) {
                var preview = '<div>';

                for (var i = 0; i < sizes.length; i++) {
                    preview += `<span class="badge bg-primary me-1">${sizes[i]}</span>`;
                }

                preview += '</div>';
                $('#optimal-sub-batches-preview').html(preview);
            }

            // Добавление произвольной подпартии
            $('#add-sub-batch-btn').click(function() {
                var index = $('#custom-sub-batches .input-group').length + 1;

                var newSubBatch = `
                    <div class="input-group mb-2">
                        <span class="input-group-text">Подпартия ${index}</span>
                        <input type="number" class="form-control custom-sub-batch" min="1">
                        <button type="button" class="btn btn-outline-danger remove-sub-batch-btn">
                            <i class="bi bi-dash"></i>
                        </button>
                    </div>
                `;

                $('#custom-sub-batches').append(newSubBatch);
                updateCustomTotal();
            });

            // Удаление произвольной подпартии
            $(document).on('click', '.remove-sub-batch-btn', function() {
                // Не удаляем, если осталось только две подпартии
                if ($('#custom-sub-batches .input-group').length <= 2) {
                    return;
                }

                $(this).closest('.input-group').remove();

                // Обновляем номера подпартий
                $('#custom-sub-batches .input-group').each(function(index) {
                    $(this).find('.input-group-text').text(`Подпартия ${index + 1}`);
                });

                updateCustomTotal();
            });

            // Изменение размера произвольной подпартии
            $(document).on('change', '.custom-sub-batch', function() {
                updateCustomTotal();
            });

            // Обновление общего количества для произвольных подпартий
            function updateCustomTotal() {
                var total = 0;

                $('.custom-sub-batch').each(function() {
                    var value = parseInt($(this).val()) || 0;
                    total += value;
                });

                $('#custom-total').text(total);

                // Выделяем общее количество красным, если оно не совпадает с целевым
                var target = parseInt($('#custom-target').text());
                if (total !== target) {
                    $('#custom-total').addClass('text-danger').removeClass('text-success');
                } else {
                    $('#custom-total').addClass('text-success').removeClass('text-danger');
                }
            }

            // Выравнивание произвольных подпартий
            $('#balance-sub-batches-btn').click(function() {
                var target = parseInt($('#custom-target').text());
                var inputs = $('.custom-sub-batch');
                var count = inputs.length;

                if (isNaN(target) || count === 0) return;

                var baseSize = Math.floor(target / count);
                var remainder = target % count;

                inputs.each(function(index) {
                    $(this).val(index < remainder ? baseSize + 1 : baseSize);
                });

                updateCustomTotal();
            });

            // Применение разделения на подпартии
            $('#apply-split-btn').click(function() {
                var strategy = $('#split-strategy').val();
                var index = $('#split-detail-index').val();
                var sizes = [];

                if (strategy === 'equal') {
                    // Равные подпартии
                    var quantity = parseInt($('#split-detail-quantity').text());
                    var count = parseInt($('#sub-batch-count').val());

                    if (isNaN(quantity) || isNaN(count) || count < 1) return;

                    var baseSize = Math.floor(quantity / count);
                    var remainder = quantity % count;

                    for (var i = 0; i < count; i++) {
                        sizes.push(i < remainder ? baseSize + 1 : baseSize);
                    }
                } else if (strategy === 'custom') {
                    // Произвольные подпартии
                    $('.custom-sub-batch').each(function() {
                        var value = parseInt($(this).val()) || 0;
                        if (value > 0) {
                            sizes.push(value);
                        }
                    });

                    // Проверяем, что общее количество совпадает с целевым
                    var total = sizes.reduce((a, b) => a + b, 0);
                    var target = parseInt($('#custom-target').text());

                    if (total !== target) {
                        alert('Общее количество деталей в подпартиях не совпадает с требуемым.');
                        return;
                    }
                } else if (strategy === 'optimal') {
                    // Оптимальный размер
                    var quantity = parseInt($('#split-detail-quantity').text());
                    var optimalSize = parseInt($('#optimal-size').val());

                    if (isNaN(quantity) || isNaN(optimalSize) || optimalSize < 1) return;

                    var remaining = quantity;

                    while (remaining > 0) {
                        var size = Math.min(remaining, optimalSize);
                        sizes.push(size);
                        remaining -= size;
                    }
                }

                // Обновляем интерфейс
                var row = $('.plan-item-row').eq(index);
                var subBatchesContainer = row.find('.sub-batches-container');

                subBatchesContainer.empty();

                if (sizes.length > 0) {
                    var html = '<div class="small">Подпартии: ';

                    for (var i = 0; i < sizes.length; i++) {
                        html += `<input type="hidden" name="Items[${index}].SubBatchSizes[${i}]" value="${sizes[i]}" />`;
                        html += `<span class="badge bg-secondary me-1">${sizes[i]}</span>`;
                    }

                    html += '</div>';
                    subBatchesContainer.html(html);
                }

                $('#splitBatchModal').modal('hide');
            });

            // Валидация формы перед отправкой
            $('#planning-form').submit(function(e) {
                // Проверяем, что в плане есть хотя бы одна деталь
                if ($('.plan-item-row').length === 0) {
                    alert('Добавьте хотя бы одну деталь в план.');
                    e.preventDefault();
                    return false;
                }

                return true;
            });
        });
    </script>
}